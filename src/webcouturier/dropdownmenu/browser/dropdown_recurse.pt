<tal:master
    define="level options/level|python:0;
            children options/children | nothing;"
    i18n:domain="plone">

<metal:main
    define-macro="nav_main"
    tal:define="enable_parent_clickable view/enable_parent_clickable;
                enable_images view/enableImages;
                image_size view/imgSize;
                enable_desc view/enableDesc">
<tal:loop repeat="node children">
  <tal:li define="item            node/item;
                  item_url        node/getURL;
                  item_remote_url node/getRemoteUrl;
                  use_remote_url  node/useRemoteUrl | nothing;
                  show_children   node/show_children;
                  children        node/children;
                  class_has_dd    python:children and ' hasDropDown' or '';
                  class_dropdown  python:children and ' dropdown-submenu' or '';
                  class_position  python:'menu-position-{0}'.format(repeat.node.number());
                  class_selected  python:' selected active' if item_url in context.absolute_url() else '';
                  class_state     string: state-${node/normalized_review_state};
                  class_clickable python:' noClick' if not enable_parent_clickable and children else '';
                  start           repeat/node/start;
                  level           node/level;
                  last            node/last;
                  q               python: chr(34);
                  li              python: '<li class={}{}{}{}{}>'.format(q, class_position, class_dropdown, class_selected, q)">

    <tal:delim condition="python: level > last"
               replace="structure python:'<ul class={}submenu dropdown-menu navTree navTreeLevel{}{}> {}'.format(q, level, q, li)" />

    <tal:delim repeat="_ python: range(last - level)"
               replace="structure python:'</li> </ul>'" />

    <tal:delim condition="python: level <= last and not start"
               replace="structure python:'</li> {}'.format(li)" />

    <a class="clearfix${class_state}${class_has_dd}${class_clickable}"
       title="${node/Description}"
       href="${python:use_remote_url and item_remote_url or item_url}">
      <span class="submenu_title">${node/Title}</span>
      <img tal:condition="python:item.getIcon and enable_images"
           src="${item_url}/@@images/image/${image_size}"
           alt=""
           class="submenu_image clearfix" />
      <span class="submenu_description"
            tal:condition="python:enable_desc and node['Description']">${node/Description}</span>
      <span tal:condition="children" class="opener"><span class="caret"></span></span>
    </a>

    <tal:end condition="repeat/node/end">
        <tal:delim repeat="_ python: range(level)"
                   replace="structure python:'</li> </ul>'" />
    </tal:end>

</tal:li>
</tal:loop>
</metal:main>
</tal:master>
